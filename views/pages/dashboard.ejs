<!DOCTYPE html>
<html lang="en">
<head>

 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VNWNXJPCYZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VNWNXJPCYZ');
</script>


  <title>Dashboard | Kiap N'Save</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9ff;
      padding: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: white;
      border-bottom: 1px solid #eee;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      height: 40px;
    }

    .logo span {
      font-size: 1.5rem;
      color: #28a745;
      font-weight: bold;
    }

    nav a {
      margin: 0 1rem;
      text-decoration: none;
      font-weight: 500;
    }

    nav a:nth-child(1) {
      color: #8e44ec;
    }

    nav a:nth-child(2) {
      color: #2980b9;
    }

    nav a:nth-child(3) {
      color: #27ae60;
    }

    .signout {
      border: 1px solid #f39c12;
      color: #f39c12;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      background: white;
      font-weight: bold;
      cursor: pointer;
    }

    .main {
      padding: 2rem;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1rem;
    }

    .tab {
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  font-weight: bold;
  border-bottom: 4px solid transparent;
  color: #666;
  background: #fff;
  transition: all 0.2s ease;
  border-radius: 6px 6px 0 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.04);
}

.tab:hover {
  background: #fff8e1;
  border-color: #f39c12;
  color: #d35400;
}

.tab.active {
  background: #fff3e0;
  border-color: #f39c12;
  color: #e67e22;
}

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: flex;
      gap: 1.5rem;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .info-box {
      flex: 1;
      min-width: 250px;
      padding: 1.5rem;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border: 2px solid #eee;
    }

    .info-box h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: bold;
    }

    .info-box .value {
      font-size: 1.8rem;
      font-weight: bold;
      margin: 0.3rem 0;
    }

    .chart-placeholder {
      width: 100%;
      height: 200px;
      background: #e0f7fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      border-radius: 8px;
    }

    .history-list {
      width: 100%;
      background: #f3f3f3;
      padding: 1rem;
      border-radius: 8px;
    }

       body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9ff;
      padding: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: white;
      border-bottom: 1px solid #eee;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo img {
      height: 40px;
    }

    .logo span {
      font-size: 1.5rem;
      color: #28a745;
      font-weight: bold;
    }

    nav a {
      margin: 0 1rem;
      text-decoration: none;
      font-weight: 500;
    }

    nav a:nth-child(1) {
      color: #8e44ec;
    }

    nav a:nth-child(2) {
      color: #2980b9;
    }

    nav a:nth-child(3) {
      color: #27ae60;
    }

    .signout {
      border: 1px solid #f39c12;
      color: #f39c12;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      background: white;
      font-weight: bold;
      cursor: pointer;
    }

    .main {
      padding: 2rem;
    }

    .card-container {
      margin-top: 1rem;
      display: flex;
      border: 3px solid orange;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .left-card, .right-card {
      flex: 1;
      padding: 2rem;
    }

    .left-card {
      background: white;
    }

    .right-card {
      background: #fff4e6;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    .upload-box {
      border: 2px dashed #dfe6e9;
      border-radius: 12px;
      background: #f9fbfc;
      padding: 2rem;
      margin-top: 1.5rem;
      text-align: center;
    }

    .upload-box i {
      font-size: 2rem;
      color: #00bcd4;
    }

    .upload-box p {
      margin: 0.5rem 0;
    }

    .highlight {
      color: orange;
      font-weight: bold;
    }

    .icon-circle {
      background: #ffe0b2;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem auto;
    }

    .icon-circle img {
      width: 32px;
      height: 32px;
    }

    .right-card p {
      color: #e67e22;
      font-weight: 500;
    }

    table {
      border-collapse: collapse;
      margin-top: 2rem;
      width: 100%;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
    }

    th {
      background-color: #f0f0f0;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }

    input.warning {
      background-color: #fff3cd;
      border-color: #ffeeba;
    }

    img {
      max-width: 100%;
      height: auto;
      margin-top: 1rem;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 1rem;
      padding: 8px 16px;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 0.75rem 1.25rem;
      border-radius: 4px;
      margin-top: 1rem;
    }

    .action-buttons button {
      margin-right: 0.5rem;
    }
  .content-wrapper {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.cat-btn {
  padding: 0.5rem 1rem;
  border: 2px solid orange;
  border-radius: 999px;
  background: #fff8e1;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s ease;
  font-size: 0.95rem;
}
.cat-btn:hover {
  background: orange;
  color: white;
}
.cat-btn.active {
  background: orange;
  color: white;
}
.uncertain-row {
    background-color: #fff8c6;
  }
  </style>
 <script>
  function initTrendChart() {
    const canvas = document.getElementById('trendChart');
    if (!canvas) {
      console.warn('‚ö†Ô∏è trendChart canvas not found!');
      return;
    }

    const ctx = canvas.getContext('2d'); // ‚úÖ <‚Äî this line goes here

    console.log("üìà Trend Labels:", trendLabels);
    console.log("üìä Trend Data:", trendData);

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: trendLabels,
        datasets: [{
          label: 'Monthly Spending ($)',
          data: trendData,
          borderColor: 'orange',
          backgroundColor: 'rgba(255,165,0,0.1)',
          tension: 0.3,
          fill: true,
          pointBackgroundColor: 'orange'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          title: {
            display: true,
            text: 'Spending Trend (This Year)',
            font: { size: 18 },
            color: '#333'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: val => '$' + val
            }
          }
        }
      }
    });
  }

  // Trigger it only when Overview tab is loaded
  window.onload = () => switchTab('overview');
</script>



  
</head>
<body>
  <header>
    <div class="logo">
      <img src="/images/logobetter.png" alt="Logo" />
      <span>Kiap N'Save</span>
    </div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="/friends">Friends</a>
      <a href="/settings">Settings</a>
    </nav>


    <div style="display: flex; align-items: center; gap: 1rem;">
<% const rawGender = user.gender?.trim().toLowerCase();
         const prefix = rawGender === 'female' ? 'Aunty' : rawGender === 'male' ? 'Uncle' : '';
         const nameCapitalized = user.name.charAt(0).toUpperCase() + user.name.slice(1); %>
      <span style="font-size: 1rem; font-weight: 500; color: #333;">
        üëã Hi again, <strong id="username"><%= prefix %> <%= nameCapitalized %>!</strong>
      </span>

  <button class="signout" onclick="location.href='/logout'" style="margin: 0;">Sign Out</button>
</div>
  </header>

  <div class="main">
    <div class="tabs">
      <div id="overview-tab" class="tab" onclick="switchTab('overview')">Overview</div>
      <div id="compare-tab" class="tab" onclick="switchTab('compare')">Compare</div>
      <div id="history-tab" class="tab" onclick="switchTab('history')">History</div>
    </div>

   <div id="overview-content" class="tab-content">
  <div class="info-box" style="border-color: orange">
  <h3 style="color: orange">Total Spent</h3>
  <div class="value">$<%= overview.totalSpent.toFixed(2) %></div>
  <p style="color: gray;">(This month)</p>
</div>

<div class="info-box" style="border-color: #2ecc71">
  <h3 style="color: #2ecc71">Top Category</h3>
  <div class="value">
    <%= overview.topCategory %> ‚Äî $<%= overview.topCategoryAmount %>
  </div>
  <p style="color: gray;">(Based on total spending this month)</p>
</div>


<div class="info-box" style="border-color: #9b59b6">
  <h3 style="color: #9b59b6">Favourite Store</h3>
  <div class="value"><%= overview.favouriteStore %></div>
  <p style="color: gray;">(Most visited this month)</p>
</div>


<!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Inject trend data -->
<script id="trend-data" type="application/json">
  {
    "labels": <%- JSON.stringify(Object.keys(spendingTrend)) %>,
    "data": <%- JSON.stringify(Object.values(spendingTrend)) %>
  }
</script>

<script>
  const parsed = JSON.parse(document.getElementById('trend-data').textContent);
  const trendLabels = parsed.labels;
  const trendData = parsed.data;

    // üîç Debug output
  console.log("üìà Trend Labels:", trendLabels);
  console.log("üìä Trend Data:", trendData);
</script>




  <!-- Spending Trend Chart -->
  <div style="width: 100%; max-width: 800px; margin: 2rem auto 0;">
    <canvas id="trendChart"></canvas>
  </div>
</div>

<div id="compare-content" class="tab-content">
  
    
    <!-- Filter Buttons -->

<!-- Comparison Bar Chart -->
<div style="width: 100%; max-width: 800px; margin: 2rem auto 0;">
  <canvas id="comparisonBarChart" style="height: 80%;"></canvas>
</div>
</div>

 

    <div id="history-content" class="tab-content">
  
      <p style="text-align: right; margin-bottom: 0.5rem;">
      <a href="/download-history" style="color: #2980b9; text-decoration: none; font-weight: 500;">
        üì• Click here to download all your data
      </a>
    </p>
  
  
  
      <table style="width: 100%; max-width: 800px; margin: auto; border-collapse: collapse; background: white; border: 1px solid #ddd;">
    <thead style="background: #f2f2f2;">
      <tr>
        <th style="padding: 0.75rem; border: 1px solid #ddd;">S/N</th>
        <th style="padding: 0.75rem; border: 1px solid #ddd;">Date</th>
        <th style="padding: 0.75rem; border: 1px solid #ddd;">Supermarket</th>
        <th style="padding: 0.75rem; border: 1px solid #ddd;">Total Cost</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">1</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">3 May 2025</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">NTUC</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">$68.40</td>
      </tr>
      <tr>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">2</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">1 May 2025</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">Cold Storage</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">$34.20</td>
      </tr>
      <tr>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">3</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">28 Apr 2025</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">RedMart</td>
        <td style="padding: 0.75rem; border: 1px solid #ddd;">$82.15</td>
      </tr>
    </tbody>
  </table>
</div>
  </div>
<div class="content-wrapper">
    <div class="card-container">
      <div class="left-card">
        <h2 class="highlight">Upload a Receipt</h2>

        <form action="/upload" method="POST" enctype="multipart/form-data">
          <input type="file" name="receipt" accept="image/*" required />
          <button type="submit">Upload & Scan</button>
        </form>

        <% if (typeof receipt !== 'undefined' && receipt) { %>
          <div class="success-message">‚úÖ Receipt uploaded and scanned successfully!</div>

          <h3>Receipt Details</h3>

<form action="/save-receipt" method="POST">
  <input type="hidden" name="imagePath" value="<%= image %>" />
<input type="hidden" name="processedImage" value="<%= processedImage %>" />
  <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1rem;">
   <div><label for="supplier">Supermarket:</label><br />
<select id="supplier" name="supplier" required>
  <option value="">Select Supermarket</option>
  <option value="NTUC Fairprice" <%= receipt.supplier_name === 'NTUC Fairprice' ? 'selected' : '' %>>NTUC Fairprice</option>
  <option value="Sheng Siong" <%= receipt.supplier_name === 'Sheng Siong' ? 'selected' : '' %>>Sheng Siong</option>
  <option value="Giant" <%= receipt.supplier_name === 'Giant' ? 'selected' : '' %>>Giant</option>
  <option value="Cold Storage" <%= receipt.supplier_name === 'Cold Storage' ? 'selected' : '' %>>Cold Storage</option>
</select></div>


    <div>
      <label for="date">Date:</label><br />
      <input type="date" id="date" name="date" value="<%= receipt.date || '' %>" required />
    </div>

    <div>
      <label for="total">Total Amount ($):</label><br />
      <input type="number" step="0.01" id="total" name="total" value="<%= receipt.total_amount || '' %>" required />
    </div>

    <div>
      <label for="discount">Total Discount ($):</label><br />
      <input type="number" step="0.01" id="discount" name="discount" value="<%= receipt.total_discount || '' %>" />
    </div>
  </div>



            <table>
  <thead>
    <tr>
      <th>Item</th>
      <th>Price</th>
      <th>Category</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="line-items">
  <% receipt.line_items.forEach((item, index) => { %>
  <% const isUncertain = item.category === 'Others' || !item.category; %>
<tr class="<%= isUncertain ? 'uncertain-row' : '' %>">

        <td>
          <input type="text" name="items[<%= index %>][description]" value="<%= item.description || '' %>" class="<%= (!item.description || item.description.length < 2) ? 'warning' : '' %>">
        </td>
        <td>
          <input type="number" step="0.01" name="items[<%= index %>][unit_price]" value="<%= item.unit_price || '' %>" class="<%= !item.unit_price ? 'warning' : '' %>">
        </td>
        <td>
         <select name="items[<%= index %>][category]">
  <option value="">Select Category</option>
  <option value="Staple" <%= item.category === 'Staple' ? 'selected' : '' %>>Staple</option>
  <option value="Fruits" <%= item.category === 'Fruits' ? 'selected' : '' %>>Fruits</option>
  <option value="Vegetables" <%= item.category === 'Vegetables' ? 'selected' : '' %>>Vegetables</option>
  <option value="Meat" <%= item.category === 'Meat' ? 'selected' : '' %>>Meat</option>
  <option value="Seafood" <%= item.category === 'Seafood' ? 'selected' : '' %>>Seafood</option>
  <option value="Dairy" <%= item.category === 'Dairy' ? 'selected' : '' %>>Dairy</option>
  <option value="Bakery" <%= item.category === 'Bakery' ? 'selected' : '' %>>Bakery</option>
  <option value="Eggs" <%= item.category === 'Eggs' ? 'selected' : '' %>>Eggs</option>
  <option value="Snacks" <%= item.category === 'Snacks' ? 'selected' : '' %>>Snacks</option>
  <option value="Beverages" <%= item.category === 'Beverages' ? 'selected' : '' %>>Beverages</option>
  <option value="Condiments" <%= item.category === 'Condiments' ? 'selected' : '' %>>Condiments</option>
  <option value="Household" <%= item.category === 'Household' ? 'selected' : '' %>>Household</option>
  <option value="Toiletries" <%= item.category === 'Toiletries' ? 'selected' : '' %>>Toiletries</option>
  <option value="Others" <%= item.category === 'Others' ? 'selected' : '' %>>Others</option>
</select>
<% if (item.category === 'Others' || !item.category) { %>
    <span title="Not sure about this" style="color: #e67e22; font-weight: bold;">‚ùó</span>
  <% } %>
        </td>
        <td class="action-buttons">
          <button type="button" onclick="this.closest('tr').remove()">üóëÔ∏è</button>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>



            <button type="button" onclick="addRow()">‚ûï Add Row</button>
            <button type="submit" id="saveBtn">üìé Save Receipt</button>
<span id="saveMsg" style="margin-left: 1rem; color: green; font-weight: 500;"></span>

          </form>

        <% } else { %>
          <p><em>No receipt data found. Try uploading a receipt above.</em></p>
        <% } %>
      </div>

      <div class="right-card">
        <% if (typeof receipt !== 'undefined' && receipt) { %>
          <h3 class="highlight">Uploaded Receipt Image</h3>
          <p>Please compare the extracted data with your receipt to ensure everything looks correct.</p>
          <img src="/<%= image %>" alt="Uploaded Receipt Image">
        <% } else { %>
          <div class="icon-circle">
            <img src="/images/thinking.png" alt="Receipt Icon" />
          </div>
          <h3 class="highlight">Instant Analysis</h3>
          <p>Kiap N' Save will extract all details automatically</p>
        <% } %>
      </div>
    </div>
  </div></div>


<!-- Chart-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartInitialized = false;

  function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tab + '-tab')?.classList.add('active');
  document.getElementById(tab + '-content')?.classList.add('active');

  if (tab === 'overview' && !window.chartInitialized) {
    setTimeout(initTrendChart, 100); // give DOM time to render
    window.chartInitialized = true;
  }
    if (tab === 'compare' && !window.barChartInitialized) {
    setTimeout(fetchComparisonData, 100);
    window.barChartInitialized = true;
  }
}

 

  window.onload = () => switchTab('overview');
</script>

<!-- Compare-->
<script>
const categoryData = {
  all:        { label: "All Categories", icon: "üìä", color: "#d35400" },
  vegetables: { label: "Vegetables", icon: "ü•¨", color: "#27ae60" },
  meat:       { label: "Meat", icon: "üçñ", color: "#c0392b" },
  seafood:    { label: "Seafood", icon: "üêü", color: "#2980b9" },
  snacks:     { label: "Snacks", icon: "üç™", color: "#e67e22" },
  beverages:  { label: "Beverages", icon: "ü•§", color: "#8e44ad" },
  eggs:       { label: "Eggs", icon: "ü•ö", color: "#e67e22" },
  staple:     { label: "Staple", icon: "üçö", color: "#f39c12" },
  dairy:      { label: "Dairy", icon: "üßÄ", color: "#3498db" },
  bakery:     { label: "Bakery", icon: "ü•ñ", color: "#cd853f" },
  condiments: { label: "Condiments", icon: "üßÇ", color: "#bdc3c7" },
  household:  { label: "Household", icon: "üßπ", color: "#34495e" },
  toiletries: { label: "Toiletries", icon: "üßª", color: "#7f8c8d" },
  others:     { label: "Others", icon: "üõí", color: "#7f8c8d" },
};


function updateComparison(selectedCategory) {
  const selected = selectedCategory || document.querySelector('.cat-btn.active')?.dataset.cat || "all";


const totalRow = document.getElementById("total-row");
if (totalRow) {
  totalRow.style.display = (selected === "all") ? "none" : "";
}

    const rows = document.querySelectorAll("#compare-table tbody tr");
    const summary = document.getElementById("comparison-summary");

    const { icon, label, color } = categoryData[selected] || categoryData["all"];
    const badgeHTML = `
      <div style="width: 48px; height: 48px; background: ${color}; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; margin-right: 1rem;">
        ${icon}
      </div>
    `;

    let summaryText = "";

    const nameTotals = {}; // person ‚Üí { april, may }

    rows.forEach(row => {
      const category = row.getAttribute("data-category");
      const isMatch = selected === "all" || category === selected;

      const name = row.cells[0].innerText.trim();
      const april = parseFloat(row.cells[1].innerText.replace('$', ''));
      const may = parseFloat(row.cells[2].innerText.replace('$', ''));

      if (!nameTotals[name]) {
        nameTotals[name] = { april: 0, may: 0, rows: [] };
      }

      nameTotals[name].rows.push(row);

      if (isMatch) {
        nameTotals[name].april += april;
        nameTotals[name].may += may;
      }

      row.style.display = selected === "all" ? "none" : (isMatch ? "" : "none");
    });

    // Generate new table for ALL mode
    const tableBody = document.querySelector("#compare-table tbody");
    const existingAggRows = document.querySelectorAll(".agg-row");
    existingAggRows.forEach(row => row.remove());

    if (selected === "all") {
      let userMay = 0;
      let peerTotal = 0;
      let peerCount = 0;

      for (const name in nameTotals) {
        const { april, may } = nameTotals[name];

        // Insert new aggregate row
        const newRow = document.createElement("tr");
        newRow.className = "agg-row";
        newRow.innerHTML = `
          <td>${name}</td>
          <td>$${april.toFixed(2)}</td>
          <td>$${may.toFixed(2)}</td>
          <td style="color: ${may - april >= 0 ? 'orange' : 'green'};">
            ${(may - april >= 0 ? '+' : '') + ((may - april) / april * 100).toFixed(1)}%
          </td>
        `;
        tableBody.appendChild(newRow);

        if (name.toLowerCase() === "you") {
          userMay = may;
        } else {
          peerTotal += may;
          peerCount++;
        }
      }

      if (peerCount > 0) {
        const peerAvg = peerTotal / peerCount;
        const diff = ((userMay - peerAvg) / peerAvg) * 100;
        const rounded = Math.abs(diff).toFixed(1);
        const direction = diff > 0 ? "more" : "less";

        summaryText = `
          <span style="font-size: 1.1rem; color: ${color}; font-weight: 500;">
            You are spending <strong>${rounded}% ${direction}</strong> this month across <strong>${label}</strong> compared to other similar Kiappers in Singapore.
          </span>
        `;
      } else {
        summaryText = `
          <span style="font-size: 1.1rem; color: ${color}; font-weight: 500;">
            No comparison available for <strong>${label}</strong>.
          </span>
        `;
      }

    } else {
      // Individual category mode
      let userMay = nameTotals["You"]?.may || 0;
      let peerTotal = 0;
      let peerCount = 0;

      for (const name in nameTotals) {
        if (name !== "You") {
          peerTotal += nameTotals[name].may;
          peerCount++;
        }
      }

      if (peerCount > 0) {
        const peerAvg = peerTotal / peerCount;
        const diff = ((userMay - peerAvg) / peerAvg) * 100;
        const rounded = Math.abs(diff).toFixed(1);
        const direction = diff > 0 ? "more" : "less";

        summaryText = `
          <span style="font-size: 1.1rem; color: ${color}; font-weight: 500;">
            You are spending <strong>${rounded}% ${direction}</strong> this month on <strong>${label}</strong> compared to other similar Kiappers in Singapore.
          </span>
        `;
      } else {
        summaryText = `
          <span style="font-size: 1.1rem; color: ${color}; font-weight: 500;">
            No comparison available for <strong>${label}</strong>.
          </span>
        `;
      }
    }

    summary.innerHTML = `
      <div style="display: flex; align-items: center;">
        ${badgeHTML}
        ${summaryText}
      </div>
    `;

    
  }

  document.addEventListener("DOMContentLoaded", updateComparison);

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('.cat-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const selected = btn.dataset.cat;
      updateComparison(selected);
    });
  });

  // trigger once at load
  updateComparison("all");
});



</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
  let barChart;
  const categoryIcons = {
    vegetables: "ü•¨", meat: "üçñ", seafood: "üêü", snacks: "üç™", beverages: "ü•§",
    eggs: "ü•ö", staple: "üçö", dairy: "üßÄ", bakery: "ü•ñ", condiments: "üßÇ",
    household: "üßπ", toiletries: "üßª", others: "üõí"
  };

  const categoryColors = {
    vegetables: "#27ae60", meat: "#c0392b", seafood: "#2980b9", snacks: "#e67e22", beverages: "#8e44ad",
    eggs: "#e67e22", staple: "#f39c12", dairy: "#3498db", bakery: "#cd853f", condiments: "#bdc3c7",
    household: "#34495e", toiletries: "#7f8c8d", others: "#7f8c8d"
  };

  let selectedMonth = new Date().getMonth(); // Default to current month

  async function fetchComparisonData(monthIndex = selectedMonth) {
    try {
      const res = await fetch(`/api/category-breakdown?month=${monthIndex}`);
      const data = await res.json();
      setTimeout(() => renderBarChart(data), 150);
    } catch (err) {
      console.error('‚ùå Failed to fetch comparison data:', err);
    }
  }

  function renderBarChart(dataMap = {}) {
    const canvas = document.getElementById("comparisonBarChart");
    if (!canvas || canvas.offsetParent === null) {
      console.warn("‚ùå comparisonBarChart canvas not visible yet");
      return;
    }

    const ctx = canvas.getContext("2d");
    const categories = Object.keys(dataMap);
    const labels = categories.map(cat => `${categoryIcons[cat.toLowerCase()] || "üìä"} ${cat}`);
    const values = Object.values(dataMap);
    const backgroundColors = categories.map(cat => categoryColors[cat.toLowerCase()] || "#f39c12");

    if (barChart) barChart.destroy();

    barChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: backgroundColors,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `$${ctx.parsed.y.toFixed(2)}`
            }
          },
          
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: val => `$${val}`
            }
          }
        }
      },
      
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const chartSection = document.getElementById("compare-content");
    if (!chartSection) return;

    const monthFilter = document.createElement("div");
    monthFilter.style.cssText = "display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:center;margin:1rem 0";
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    months.forEach((label, i) => {
      const btn = document.createElement("button");
      btn.className = "cat-btn month-btn" + (i === selectedMonth ? " active" : "");
      btn.textContent = label;
      btn.onclick = () => {
        selectedMonth = i;
        document.querySelectorAll(".month-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        fetchComparisonData(i);
      };
      monthFilter.appendChild(btn);
    });

    chartSection.prepend(monthFilter);

    const observer = new MutationObserver(() => {
      const canvas = document.getElementById("comparisonBarChart");
      if (canvas && canvas.offsetParent !== null) {
        fetchComparisonData();
        observer.disconnect();
      }
    });

    observer.observe(chartSection, { attributes: true, attributeFilter: ['class'], subtree: true });
  });
</script>





</body>
</html>
